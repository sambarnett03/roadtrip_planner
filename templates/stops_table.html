<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stops ‚Äî Editable</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 20px; background: #fafafa; }
    .container { max-width: 1100px; margin: 0 auto; padding-bottom: 80px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .stop-card { background: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); display:flex; gap:12px; align-items:flex-start; position: relative; }
    
    .left { width: 72px; text-align:center; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 12px; }
    .meta { font-size: 0.9rem; color: #888; font-weight: bold; }
    
    .drag-handle { cursor: grab; user-select: none; padding: 8px 10px; border-radius: 8px; background:#f3f4f6; color: #555; font-size: 1.2rem; line-height: 1; }
    .drag-handle:active { cursor: grabbing; background: #e5e7eb; }

    /* New Delete Button Styles */
    .delete-btn {
      background: none; border: none; cursor: pointer; color: #dc3545; 
      font-size: 1.2rem; opacity: 0.6; transition: opacity 0.2s, color 0.2s;
      padding: 4px;
    }
    .delete-btn:hover { opacity: 1; color: #b02a37; }

    .fields { flex: 1; display:flex; flex-direction:column; gap:8px; }
    .field-row { display:flex; gap:8px; align-items:flex-start; }
    .field-key { width:160px; font-weight:600; color:#333; margin-top: 8px; font-size: 0.95rem; }
    .field-value { flex: 1; }
    
    .field-value input[type="text"], 
    .field-value input[type="number"], 
    .field-value textarea { width:100%; padding:8px 10px; border-radius:6px; border:1px solid #e6e6e6; font-family: inherit; font-size: 0.95rem; box-sizing: border-box; }
    .field-value textarea { min-height:48px; resize:vertical; }
    .field-value input[type="checkbox"] { transform:scale(1.3); margin-top: 10px; cursor: pointer; }
    .field-value input[readonly] { background-color: #f9fafb; color: #666; border-color: #eee; cursor: not-allowed; }

    #status { margin-top: 14px; color:#333; font-weight: 500; height: 1.5em; }
    #button-container { position: fixed; bottom: 5vh; right: 5vw; display: flex; flex-direction: column; align-items: flex-end; gap: 1vh; z-index: 9999; }
    .action-button { background-color: white; padding: 10px 15px; border-radius: 8px; font-weight: bold; color: #007BFF; text-decoration: none; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); transition: background-color 0.2s ease; }
    .action-button:hover { background-color: #f0f0f0; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Stops ‚Äî Editable</h1>
    <p style="color:#666; margin-bottom: 20px;">Edit details below. Drag ‚ò∞ to reorder. Use üóë to delete.</p>
    
    <div id="status"></div>

    <div id="stops-grid" class="grid" aria-live="polite">
        <div style="color:#888; font-style:italic;">Loading stops...</div>
    </div>
  </div>

  <div id="button-container">
    {% if owner_id %}
      <a href="{{ url_for('open_map_shared', owner_id=owner_id, map_id=map_id) }}" class="action-button">‚Üê Back to Map</a>
    {% else %}
      <a href="{{ url_for('open_map', map_id=map_id) }}" class="action-button">‚Üê Back to Map</a>
    {% endif %}
  </div>

  <script>
    // Server-injected variables
    const MAP_ID = {{ map_id | tojson }};
    const OWNER_ID = {{ owner_id | tojson }};

    let VISIBLE_KEYS = [
      { key: "name", label: "Place Name", type: "text", readonly: true },
      { key: "nickname", label: "Nickname", type: "text" },
      { key: "desc", label: "Description", type: "text" },
      { key: "overnight", label: "Overnight Stay", type: "bool" },
      { key: "inc_drive", label: "Drive through this point, label as parking, or add as POI (y/n/p)", type: "text" }
    ];

    const ownerParam = OWNER_ID || '';
    function stopsUrl(mapId) {
      return '/api/stops?map_id=' + encodeURIComponent(mapId) + (ownerParam ? ('&owner_id=' + encodeURIComponent(ownerParam)) : '');
    }
    function withOwner(obj) {
      const copy = Object.assign({}, obj || {});
      if (ownerParam) copy.owner_id = ownerParam;
      return copy;
    }
    function escapeHtml(s) {
      if (s === undefined || s === null) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function debounce(fn, wait=500) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      };
    }

    // UI Refs
    const grid = document.getElementById('stops-grid');
    const statusEl = document.getElementById('status');
    
    function setStatus(msg, isError=false) {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? '#d32f2f' : '#2e7d32';
      if (!msg) statusEl.innerHTML = '&nbsp;';
    }

    // 1. Load Data
    async function loadStops() {
      setStatus('Loading...');
      try {
        const resp = await fetch(stopsUrl(MAP_ID), { credentials: 'same-origin' });
        if (!resp.ok) throw new Error(`Server returned ${resp.status}`);
        const data = await resp.json();
        
        if (data.map_meta && Array.isArray(data.map_meta.visible_fields) && data.map_meta.visible_fields.length) {
          VISIBLE_KEYS = data.map_meta.visible_fields;
        }
        
        renderStops(data.stops || []);
        setStatus('');
      } catch (err) {
        console.error(err);
        setStatus('Error loading stops: ' + err.message, true);
      }
    }

    // 2. Render Grid
    function renderStops(stops) {
      grid.innerHTML = '';
      if (stops.length === 0) {
        grid.innerHTML = '<div style="padding:20px; color:#666;">No stops found on this map.</div>';
        return;
      }

      stops.forEach((stop, idx) => {
        const card = document.createElement('div');
        card.className = 'stop-card';
        card.dataset.docId = stop._doc_id || '';

        // --- LEFT COLUMN (ID, Drag, Delete) ---
        const left = document.createElement('div');
        left.className = 'left';
        
        // 1. ID Number
        const metaDiv = document.createElement('div');
        metaDiv.className = 'meta';
        metaDiv.textContent = `#${idx+1}`;
        left.appendChild(metaDiv);
        
        // 2. Drag Handle
        const dragDiv = document.createElement('div');
        dragDiv.className = 'drag-handle';
        dragDiv.innerHTML = '‚ò∞';
        dragDiv.title = "Drag to reorder";
        left.appendChild(dragDiv);

        // 3. Delete Button (NEW)
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.innerHTML = 'üóë'; // trash icon
        delBtn.title = "Delete this stop";
        delBtn.onclick = () => deleteStop(stop._doc_id, card);
        left.appendChild(delBtn);

        card.appendChild(left);

        // --- FIELDS COLUMN ---
        const fields = document.createElement('div');
        fields.className = 'fields';

        VISIBLE_KEYS.forEach(conf => {
          const key = conf.key;
          const label = conf.label || key;
          const type = conf.type || 'text';
          const isReadonly = !!conf.readonly;

          let rawVal = stop.hasOwnProperty(key) ? stop[key] : '';
          
          const row = document.createElement('div');
          row.className = 'field-row';
          
          let inputHtml = '';
          const commonAttrs = `data-field="${escapeHtml(key)}" ${isReadonly ? 'readonly' : ''}`;

          if (type === 'bool') {
            const checked = rawVal ? 'checked' : '';
            inputHtml = `<div class="field-value"><input type="checkbox" ${commonAttrs} ${checked} ${isReadonly ? 'disabled' : ''}></div>`;
          } 
          else if (type === 'number') {
            const valStr = (rawVal === null || rawVal === undefined) ? '' : String(rawVal);
            inputHtml = `<div class="field-value"><input type="number" value="${escapeHtml(valStr)}" ${commonAttrs}></div>`;
          } 
          else {
            const valStr = (rawVal === null || rawVal === undefined) ? '' : String(rawVal);
            if (valStr.length > 60 || valStr.includes('\n') || key === 'desc') {
                inputHtml = `<div class="field-value"><textarea rows="2" ${commonAttrs}>${escapeHtml(valStr)}</textarea></div>`;
            } else {
                inputHtml = `<div class="field-value"><input type="text" value="${escapeHtml(valStr)}" ${commonAttrs}></div>`;
            }
          }

          row.innerHTML = `<div class="field-key">${escapeHtml(label)}</div>` + inputHtml;
          fields.appendChild(row);
        });

        card.appendChild(fields);
        grid.appendChild(card);
      });

      hookupInlineEditing();
      initReorderSortable();
    }

    // 3. Update Visual IDs (Ensures continuity)
    function updateVisualIndices() {
        const cards = Array.from(grid.querySelectorAll('.stop-card'));
        cards.forEach((c, i) => {
            const meta = c.querySelector('.meta');
            if (meta) meta.textContent = `#${i+1}`;
        });
    }

    // 4. Delete Function
    async function deleteStop(docId, cardElement) {
        if (!confirm("Are you sure you want to delete this stop? This cannot be undone.")) return;
        
        setStatus('Deleting...');
        cardElement.style.opacity = '0.5';

        try {
            const payload = withOwner({ map_id: MAP_ID, doc_id: docId });
            
            const resp = await fetch('/api/stops/delete', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!resp.ok) {
                const text = await resp.text();
                throw new Error(`Server ${resp.status}: ${text}`);
            }

            // Remove from DOM
            cardElement.remove();
            
            // Re-calculate numbers immediately
            updateVisualIndices();
            
            setStatus('Stop deleted.', false);
            setTimeout(() => setStatus(''), 2000);
        } catch (err) {
            console.error(err);
            cardElement.style.opacity = '1';
            setStatus('Failed to delete: ' + err.message, true);
        }
    }

    // 5. Edit Listeners
    function hookupInlineEditing() {
      grid.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(el => {
        if (el.readOnly) return;
        
        const docId = el.closest('.stop-card').dataset.docId;
        const field = el.dataset.field;
        
        const saveFn = debounce(async (val) => {
          await patchField(docId, field, val);
        }, 600); 

        el.addEventListener('input', (e) => saveFn(e.target.value));
      });

      grid.querySelectorAll('input[type="checkbox"]').forEach(chk => {
        if (chk.disabled) return;
        const docId = chk.closest('.stop-card').dataset.docId;
        const field = chk.dataset.field;
        chk.addEventListener('change', async (e) => {
          await patchField(docId, field, e.target.checked);
        });
      });
    }

    async function patchField(docId, field, value) {
      if (!docId || !field) return;
      setStatus(`Saving ${field}...`);
      try {
        const payload = withOwner({ map_id: MAP_ID, doc_id: docId, field: field, value: value });
        const resp = await fetch('/api/stops/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error(await resp.text());
        setStatus('Saved.', false);
        setTimeout(() => { if(statusEl.textContent === 'Saved.') setStatus(''); }, 2000);
      } catch (err) {
        setStatus('Failed to save: ' + err.message, true);
      }
    }

    // 6. Reordering
    function initReorderSortable() {
      if (grid.dataset.sortableInitialized) return;
      grid.dataset.sortableInitialized = '1';

      new Sortable(grid, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'dragging-ghost',
        onStart: e => e.item.style.opacity = '0.5',
        onEnd: async e => {
          e.item.style.opacity = '';
          updateVisualIndices(); // Update numbers on drop
          
          const cards = Array.from(grid.querySelectorAll('.stop-card'));
          const order = cards.map(c => c.dataset.docId);
          await saveOrder(order);
        }
      });
    }

    async function saveOrder(order) {
      setStatus('Reordering...');
      try {
        const payload = withOwner({ map_id: MAP_ID, order: order });
        const resp = await fetch('/api/stops/reorder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error(await resp.text());
        setStatus(`New order saved.`);
        setTimeout(() => setStatus(''), 2000);
      } catch (err) {
        setStatus('Reorder failed: ' + err.message, true);
      }
    }

    loadStops();
  </script>
</body>
</html>